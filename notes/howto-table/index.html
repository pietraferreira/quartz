<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Howto Table a.k.a. Relocation Table  The relocation table records the list of items that the file needs (from other object files or libraries)."><title>Howto Table</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=ico href=https://pietraferreira.github.io/quartz//favicon.ico><link href=https://pietraferreira.github.io/quartz/styles.591589daec716a7d5287f8d56c2c091e.min.css rel=stylesheet><link href=https://pietraferreira.github.io/quartz/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://pietraferreira.github.io/quartz/js/darkmode.a93be4d36d657139e957880e320dd457.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://pietraferreira.github.io/quartz/js/popover.37b1455b8f0603154072b9467132c659.min.js></script>
<script src=https://pietraferreira.github.io/quartz/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://pietraferreira.github.io/quartz/js/clipboard.25155053855f45fdc48fd92540bcebc9.min.js></script>
<script>const BASE_URL="https://pietraferreira.github.io/quartz/",fetchData=Promise.all([fetch("https://pietraferreira.github.io/quartz/indices/linkIndex.bf4ca7a5a475a19691d32e4b6ce1b148.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://pietraferreira.github.io/quartz/indices/contentIndex.3fdc93645af100274eb1ed0cbb6c8d50.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const n=new URL(BASE_URL),s=n.pathname,o=window.location.pathname,i=s==o;addCopyButtons(),addTitleToCodeBlocks();const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=i&&!1;drawGraph("https://pietraferreira.github.io/quartz",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2}),initPopover("https://pietraferreira.github.io/quartz",!0,!0)},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/pietraferreira.github.io\/quartz\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-XYFD95KB4J"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XYFD95KB4J",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://pietraferreira.github.io/quartz/js/search.cf33b507388f3dfd5513a2afcda7af41.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://pietraferreira.github.io/quartz/>ü™Ö Morioh</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Howto Table</h1><p class=meta>Last updated
Jul 3, 2022</p><ul class=tags><li><a href=https://pietraferreira.github.io/quartz/tags/work/>Work</a></li><li><a href=https://pietraferreira.github.io/quartz/tags/relocations/>Relocations</a></li></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#how-it-works-according-to-core-v>How it works (according to CORE-V)</a><ol><li><a href=#tc-riscvc-312948-steps><code>tc-riscv.c (:3129/48)</code> steps</a></li></ol></li></ol></nav></details></aside><a href=#howto-table-aka-relocation-table><h1 id=howto-table-aka-relocation-table><span class=hanchor arialabel=Anchor># </span>Howto Table a.k.a. Relocation Table</h1></a><hr><p>The relocation table records the list of items that the file needs (from other object files or libraries).</p><ul><li>The relocation record contains information like: which instructions need to be
relocated (the offsets), which symbols are involved with the relocation and how to
relocate the files relative to the symbols.</li></ul><a href=#how-it-works-according-to-core-v><h2 id=how-it-works-according-to-core-v><span class=hanchor arialabel=Anchor># </span>How it works (according to CORE-V)</h2></a><a href=#tc-riscvc-312948-steps><h3 id=tc-riscvc-312948-steps><span class=hanchor arialabel=Anchor># </span><code>tc-riscv.c (:3129/48)</code> steps</h3></a><ol><li>Check that symbol address exists via <code>fixP‚Üífx_addsy</code>. If false the case will just break and not go through the following steps.</li><li>Uses the howto table to look up the relocation. The howto table can be found in <code>bfd/elfxx-riscv.c</code>. The first field uses the table from <code>include/elf/riscv.h</code>.</li><li>Set the <em>delta</em> and <em>target</em> values to increase objdump readability.</li></ol><ul><li><em>Delta</em> is the PC relative value found via ‚Äú<em>target - md_pcrel_from (fixP)‚Äù</em>, where fixP is the symbol.</li><li><em>Target</em> is the value of the symbol found using <code>S_GET_VALUE</code>. Since the symbol is local, it will use <code>resolve_symbol_value</code> to find the value. This is called during the final pass over the symbol table to resolve any symbols with complex values.</li></ul><ol start=4><li>Check if the relocation overflows. <code>bfd_check_overflow</code> will return <code>bfd_reloc_ok</code> or <code>bfd_reloc_overflow</code>. If overflow, <code>as_fatal</code> will be used, ending the assembly.</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>bfd_reloc_status_type</span> <span class=nf>bfd_check_overflow</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=k>enum</span> <span class=n>complain_overflow</span> <span class=n>how</span><span class=p>,</span> <span class=c1>// howto-&gt;complain_on_overflow_
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>bitsize</span><span class=p>,</span> <span class=c1>// Relocation has bitsize significant bits_
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>rightshift</span><span class=p>,</span> <span class=o>//</span> <span class=n>This</span> <span class=n>relocation</span> <span class=n>requires</span> <span class=n>right</span> <span class=n>shift</span> <span class=n>by</span> <span class=mi>1</span> <span class=p>(</span><span class=n>common</span><span class=p>)</span><span class=n>_</span>
</span></span><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>addrsize</span><span class=p>,</span> <span class=c1>// Machine has addrsize significant bits_
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>bfd_vma</span> <span class=n>relocation</span><span class=p>);</span> <span class=c1>// The relocation found in the howto table_
</span></span></span></code></pre></td></tr></table></div></div><ol start=5><li>Remove some of the information from the header records of object files using <code>bfd_putl32</code>. The function masks to remove the information.</li><li>bfd_byte *addr = (bfd_byte *) p;
addr[0] = data & 0xff;
addr[1] = (data &#187; 8) & 0xff;
addr[2] = (data &#187; 16) & 0xff;
addr[3] = (data &#187; 24) & 0xff;
}</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>-</span><span class=w> </span><span class=n>Important</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>know</span><span class=w> </span><span class=n>that</span><span class=w> </span><span class=o>`</span><span class=n>R_RISCV_32</span><span class=o>`</span><span class=w> </span><span class=k>is</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=n>runtime</span><span class=w> </span><span class=n>relocation</span><span class=w> </span><span class=k>with</span><span class=w> </span><span class=n>field</span><span class=w> </span><span class=n>of</span><span class=w> </span><span class=o>**</span><span class=n>word32</span><span class=o>**</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=n>calculation</span><span class=w> </span><span class=o>**</span><span class=n>S</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>A</span><span class=o>**</span><span class=w> </span><span class=p>(</span><span class=n>symbol</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>addend</span><span class=p>).</span><span class=w> </span><span class=n>The</span><span class=w> </span><span class=n>addend</span><span class=w> </span><span class=k>is</span><span class=w> </span><span class=n>used</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>compute</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=n>of</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>relocatable</span><span class=w> </span><span class=n>field</span><span class=w> </span><span class=k>while</span><span class=w> </span><span class=n>S</span><span class=w> </span><span class=n>represents</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=n>of</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>symbol</span><span class=w> </span><span class=n>whose</span><span class=w> </span><span class=k>index</span><span class=w> </span><span class=n>reside</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>relocation</span><span class=w> </span><span class=n>entry</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>## Example
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>```</span><span class=n>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>HOWTO</span><span class=w> </span><span class=p>(</span><span class=n>R_RISCV_CVPCREL_UI12</span><span class=p>,</span><span class=w>          </span><span class=cm>/* type */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=mi>1</span><span class=p>,</span><span class=w>                             </span><span class=cm>/* rightshift */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=mi>2</span><span class=p>,</span><span class=w>                             </span><span class=cm>/* size */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=mi>32</span><span class=p>,</span><span class=w>                            </span><span class=cm>/* bitsize */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=no>TRUE</span><span class=p>,</span><span class=w>                          </span><span class=cm>/* pc_relative */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=mi>0</span><span class=p>,</span><span class=w>                             </span><span class=cm>/* bitpos */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>complain_overflow_unsigned</span><span class=p>,</span><span class=w>    </span><span class=cm>/* complain_on_overflow */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>bfd_elf_generic_reloc</span><span class=p>,</span><span class=w>         </span><span class=cm>/* special_function */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=s2>&#34;R_RISCV_CVPCREL_UI12&#34;</span><span class=p>,</span><span class=w>        </span><span class=cm>/* name */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=no>FALSE</span><span class=p>,</span><span class=w>                         </span><span class=cm>/* partial_inplace */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=mi>0</span><span class=p>,</span><span class=w>                             </span><span class=cm>/* src_mask */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nf>ENCODE_ITYPE_IMM</span><span class=w> </span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=n>U</span><span class=p>),</span><span class=w>        </span><span class=cm>/* dst_mask */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=no>TRUE</span><span class=p>),</span><span class=w>                         </span><span class=cm>/* pcrel_offset */</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li><em>type</em>: type field is there mainly for documentary use, meaning that the back end can do what it wants with it. It is important to note that normally the back end will store their idea of an external relocation number in this field.</li><li><em>right shift</em>: the value the final relocation is shifted right by, it drops any unwanted data from the relocation</li><li><em>size</em>: encoded size of the item to be relocated, it is not a power of two measure. You can use <code>bfd_get_reloc_size</code> to find the size of the item in bytes.</li><li><em>bitsize</em>: the number of bits in the field to be relocated, it is used when doing overflow checking.</li><li><em>pc_relative</em>: boolean -> if the relocation is relative to the item being relocated.</li><li><em>bitpos</em>: the bit position of the relocation value in the destination. The relocated value is left shifted by this amount.</li><li><em>complain_on_overflow</em>: what type of overflow error should be checked for when relocating -> Complain if the value overflows when considered as an unsigned number.</li><li><em>special_function</em>: if this field is non-null (it is) then the supplied function is called rather than the normal function, allowing really strange relocations to be accomplished.<ul><li><em>bfd_elf_generic_reloc</em>: in <code>bfd/elf.c:1307</code> -> it is for relocations against symbols (<code>SHT_RELA</code> etc).</li></ul></li><li><em>name</em>: textual name of the relocation type.</li><li><em>partial_inplace</em>: some formats record a relocation addend in the section contents rather than with the relocation. For ELF formats this is the distinction between <code>USE_REL</code> and <code>USE_RELA</code>. The value is false if addends are recorded within the relocations. All relocations for all ELF <code>USE_RELA</code> targets should set this field to false.</li><li><em>src_mask</em>: it detected the part of the instruction to be used in the relocation sum -> if relocations do have an addend in the relocation, then this field should normally be zero.</li><li><em>dst_mask</em>: selects which part of the instruction are replaced with a relocated value.</li><li><em>pcrel_offset</em>: when some formats create PC relative instructions, they leave the value of the pc of the place being relocated in the offset slot of the instruction, so that a PC relative relocation can be made by just adding in an ordinary offset. in the cases that the displacement part of the instruction is empty, this flags signals the fact.</li></ul></article><hr><div class=page-end><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li><a href=/quartz/notes/relocations/ data-ctx="howto table" data-src=/notes/relocations class=internal-link>Relocations</a></li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://pietraferreira.github.io/quartz/js/graph.afdb02e537635f9a611b53a988e5645b.js></script></div></div><div id=contact_buttons><footer><p>Made by Morioh using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, ¬© 2022</p><ul><li><a href=https://pietraferreira.github.io/quartz/>Home</a></li><li><a href=https://github.com/pietraferreira>Github</a></li></ul></footer></div></div></body></html>