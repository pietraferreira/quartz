<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="LLVM  The LLVM Project is a collection of modular and reusable compiler and toolchain technologies. Prebuilt binaries of the LLVM toolchain can be downloaded from¬†the LLVM Download Page."><title>LLVM</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=ico href=https://pietraferreira.github.io/quartz//favicon.ico><link href=https://pietraferreira.github.io/quartz/styles.591589daec716a7d5287f8d56c2c091e.min.css rel=stylesheet><link href=https://pietraferreira.github.io/quartz/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://pietraferreira.github.io/quartz/js/darkmode.a93be4d36d657139e957880e320dd457.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://pietraferreira.github.io/quartz/js/popover.37b1455b8f0603154072b9467132c659.min.js></script>
<script src=https://pietraferreira.github.io/quartz/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://pietraferreira.github.io/quartz/js/clipboard.25155053855f45fdc48fd92540bcebc9.min.js></script>
<script>const BASE_URL="https://pietraferreira.github.io/quartz/",fetchData=Promise.all([fetch("https://pietraferreira.github.io/quartz/indices/linkIndex.232db6e711fc8600f4d7ff9e1de10d0e.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://pietraferreira.github.io/quartz/indices/contentIndex.d286afde09e2a2e3f9cc7764362fd233.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const n=new URL(BASE_URL),s=n.pathname,o=window.location.pathname,i=s==o;addCopyButtons(),addTitleToCodeBlocks();const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=i&&!1;drawGraph("https://pietraferreira.github.io/quartz",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2}),initPopover("https://pietraferreira.github.io/quartz",!0,!0)},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/pietraferreira.github.io\/quartz\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-XYFD95KB4J"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XYFD95KB4J",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://pietraferreira.github.io/quartz/js/search.cf33b507388f3dfd5513a2afcda7af41.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://pietraferreira.github.io/quartz/>ü™Ö Morioh</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>LLVM</h1><p class=meta>Last updated
Jul 3, 2022</p><ul class=tags><li><a href=https://pietraferreira.github.io/quartz/tags/compilers/>Compilers</a></li><li><a href=https://pietraferreira.github.io/quartz/tags/cs-concept/>Cs concept</a></li></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#three-phase-design>Three-phase design</a></li><li><a href=#llvm-intermediate-representation-ir>LLVM Intermediate Representation (IR)</a></li><li><a href=#llvms-target-description-files-td>LLVM&rsquo;s Target Description Files: .td</a></li><li><a href=#code-generation-sequence>Code Generation Sequence</a></li><li><a href=#llvm-vs-gcc-in-structure>LLVM vs GCC in structure</a></li><li><a href=#online-resources>Online resources</a><ol><li><a href=#mailing-lists>Mailing lists</a></li></ol></li><li><a href=#resources>Resources</a></li></ol></nav></details></aside><a href=#llvm><h1 id=llvm><span class=hanchor arialabel=Anchor># </span>LLVM</h1></a><hr><p>The LLVM Project is a collection of modular and reusable
<a href=/quartz/notes/compilers/ rel=noopener class=internal-link data-src=/quartz/notes/compilers/>compiler</a> and toolchain technologies. Prebuilt binaries of the LLVM toolchain can be downloaded from¬†the
<a href=https://releases.llvm.org/download.html rel=noopener>LLVM Download Page</a>. The toolchain can also be built from source by following the instructions from their¬†
<a href=https://llvm.org/docs/ rel=noopener>documentation page</a>. The toolchain contains the following top-level directories:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>bin include lib libexec share
</span></span></code></pre></td></tr></table></div></div><p>The <code>bin</code> folder contains all the executable binaries, like the clang
<a href=/quartz/notes/compilers/ rel=noopener class=internal-link data-src=/quartz/notes/compilers/>compiler</a> and a set of other useful tools such as clang-rename, clang-refactor, etc.</p><p>The <code>include</code> folder contains a set of header files that are included during compilation. For example, the C++ header files like iostream, etc. Notice that the C header files like <code>stdio.h</code> are not supplied with the toolchain because they are part of the
<a href=/quartz/notes/sysroot/ rel=noopener class=internal-link data-src=/quartz/notes/sysroot/>sysroot</a>. It also contains header files that are used when using the llvm libraries to build tools.</p><p>The <code>lib</code> folder contains libraries like libc++, libc++abi, etc. These libraries may be used by the clang
<a href=/quartz/notes/compilers/ rel=noopener class=internal-link data-src=/quartz/notes/compilers/>compiler</a> during the compilation process or can be used as a reusable set of libraries.</p><p>The <code>libexec</code> folder contains two Python scripts that are only relevant for using the clang static analyser.</p><p>The <code>share</code> folder contains the documentation which can be installed as <em>man</em> pages and a non-essential set of scripts.</p><a href=#three-phase-design><h2 id=three-phase-design><span class=hanchor arialabel=Anchor># </span>Three-phase design</h2></a><p>Front end, optimiser and back end (as most C compilers).</p><ul><li>Front end: parses source code, checking it for errors and builds a language-specific Abstract Syntax Tree (AST) to represent the input code. The AST is optionally converted to a new representation for optimisation, and the optimiser and back end are run on the code.</li></ul><p><img src=https://pietraferreira.github.io/quartz//notes/images/three-phase-compiler.png width=auto alt></p><ul><li><p>Optimiser: responsible for transforming the code to improve running time, for example by eliminating redundant computations, and it is usually more of less independent of language and target.</p></li><li><p>Back end: aka code generator, maps the code onto the target instruction set. It is also responsible for generating good code that takes advantage of the unusual features of the supported architecture. Common parts of a compiler back end are: instruction selection, register allocation and instruction scheduling.</p></li></ul><p>The most important win of this classical design comes when a compiler decides to support multiple source languages or target architectures. If the compiler uses a common code representation in its optimiser, then a front end can be written for any language that can compile to it, and a back end can be written for any target that can compile from it (as seen bellow).</p><p><img src=https://pietraferreira.github.io/quartz//notes/images/retargetability.png width=auto alt></p><a href=#llvm-intermediate-representation-ir><h2 id=llvm-intermediate-representation-ir><span class=hanchor arialabel=Anchor># </span>LLVM Intermediate Representation (IR)</h2></a><p>Is the form LLVm uses to represent code in the compiler. It is designed to host mid-level analyses and transformations that can be found in the optimisation phase.</p><p>It was designed with many specific goals in mind, including supporting lightweight runtime optimisation, cross-function/inter-procedural optimisations, whole program analyses and aggressive restructuring transformations.</p><p>The most important aspect however, is that it is itself defined as a first class language with well-defined semantics. Here is a simple example of a <code>.ll</code> file:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-LLVM data-lang=LLVM><span class=line><span class=cl><span class=k>define</span> <span class=k>i32</span> <span class=vg>@add1</span><span class=p>(</span><span class=k>i32</span> <span class=nv>%a</span><span class=p>,</span> <span class=k>i32</span> <span class=nv>%b</span><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl><span class=nl>entry:</span>  
</span></span><span class=line><span class=cl>    <span class=nv>%tmp1</span> <span class=p>=</span> <span class=k>add</span> <span class=k>i32</span> <span class=nv>%a</span><span class=p>,</span> <span class=nv>%b</span>  
</span></span><span class=line><span class=cl>    <span class=k>ret</span> <span class=k>i32</span> <span class=nv>%tmp1</span>  
</span></span><span class=line><span class=cl><span class=p>}</span>  
</span></span><span class=line><span class=cl><span class=k>define</span> <span class=k>i32</span> <span class=vg>@add2</span><span class=p>(</span><span class=k>i32</span> <span class=nv>%a</span><span class=p>,</span> <span class=k>i32</span> <span class=nv>%b</span><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl><span class=nl>entry:</span>  
</span></span><span class=line><span class=cl>    <span class=nv>%tmp1</span> <span class=p>=</span> <span class=k>icmp</span> <span class=k>eq</span> <span class=k>i32</span> <span class=nv>%a</span><span class=p>,</span> <span class=m>0</span>  
</span></span><span class=line><span class=cl>    <span class=k>br</span> <span class=k>i1</span> <span class=nv>%tmp1</span><span class=p>,</span> <span class=kt>label</span> <span class=nv>%done</span><span class=p>,</span> <span class=kt>label</span> <span class=nv>%recurse</span>  
</span></span><span class=line><span class=cl><span class=nl>recurse:</span>  
</span></span><span class=line><span class=cl>    <span class=nv>%tmp2</span> <span class=p>=</span> <span class=k>sub</span> <span class=k>i32</span> <span class=nv>%a</span><span class=p>,</span> <span class=m>1</span>  
</span></span><span class=line><span class=cl>    <span class=nv>%tmp3</span> <span class=p>=</span> <span class=k>add</span> <span class=k>i32</span> <span class=nv>%b</span><span class=p>,</span> <span class=m>1</span>  
</span></span><span class=line><span class=cl>    <span class=nv>%tmp4</span> <span class=p>=</span> <span class=k>call</span> <span class=k>i32</span> <span class=vg>@add2</span><span class=p>(</span><span class=k>i32</span> <span class=nv>%tmp2</span><span class=p>,</span> <span class=k>i32</span> <span class=nv>%tmp3</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>    <span class=k>ret</span> <span class=k>i32</span> <span class=nv>%tmp4</span>  
</span></span><span class=line><span class=cl><span class=nl>done:</span>  
</span></span><span class=line><span class=cl>    <span class=k>ret</span> <span class=k>i32</span> <span class=nv>%b</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>Which corresponds to this C code:</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>unsigned</span> <span class=nf>add1</span><span class=p>(</span><span class=kt>unsigned</span> <span class=n>a</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=n>b</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>unsigned</span> <span class=nf>add2</span><span class=p>(</span><span class=kt>unsigned</span> <span class=n>a</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=n>b</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>a</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>add2</span><span class=p>(</span><span class=n>a</span> <span class=o>-</span> <span class=mi>1</span><span class=p>,</span> <span class=n>b</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>As you can see, the instructions (in LLVM IR) are in
<a href=/quartz/notes/three-address-code/ rel=noopener class=internal-link data-src=/quartz/notes/three-address-code/>three address form</a>, which means they take some number of inputs and produce a result in a different register.</p><p>It also does not use a fixed set of named registers, it uses an infinite set of temporaries named with a <code>%</code> character.</p><p>Beyond being implemented as a language, LLVM IR is actually defined in three isomorphic forms: the textual format above, an in-memory data structure inspected and modified by optimisations themselves, and an efficient and dense on-disk binary ‚Äúbitcode‚Äù format. The LLVM Project also provides tools to convert the on-disk format from text to binary: llvm-as assembles the textual .ll file into a .bc file containing the bitcode goop and llvm-dis turns a .bc file into a .ll file.</p><p>The intermediate representation of a compiler is interesting because it can be a ‚Äúperfect world‚Äù for the compiler optimiser: unlike the front end and back end of the compiler, the optimiser isn‚Äôt constrained by either a specific source language or a specific target machine. On the other hand, it has to serve both well: it has to be designed to be easy for a front end to generate and be expressive enough to allow important optimisations to be performed for real targets</p><a href=#llvms-target-description-files-td><h2 id=llvms-target-description-files-td><span class=hanchor arialabel=Anchor># </span>LLVM&rsquo;s Target Description Files: .td</h2></a><p>Each shared component needs to be able to reason about target specific properties in a generic way. For example, a shared register allocator needs to know the register file of each target and the constraints that exist between instructions and their register operands.</p><p>LLVM&rsquo;s solution to this is for each target to provide a <strong>target description</strong> in a declarative domain-specific language (a set of <code>.td</code> files) processed by the <strong>tblgen</strong> tool. Here is the build process for the x86 target:</p><p><img src=https://pietraferreira.github.io/quartz//notes/images/x86-target-definition-example.png width=auto alt></p><p>The different subsystems supported by the <code>.td</code> files allow target authors to build up the different pieces of their target. For example, the x86 back end defines a register class that holds all of its 32-bit registers name &ldquo;GR32&rdquo;, like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-LLVM data-lang=LLVM><span class=line><span class=cl><span class=k>define</span> <span class=nl>GR32 :</span> <span class=err>RegisterClass</span><span class=p>&lt;[</span><span class=k>i32</span><span class=p>],</span> <span class=m>32</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=err>EAX</span><span class=p>,</span> <span class=err>ECX</span><span class=p>,</span> <span class=err>EDX</span><span class=p>,</span> <span class=err>ESI</span><span class=p>,</span> <span class=err>EDI</span><span class=p>,</span> <span class=err>EBX</span><span class=p>,</span> <span class=err>EBP</span><span class=p>,</span> <span class=err>ESP</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>   <span class=err>R</span><span class=m>8</span><span class=err>D</span><span class=p>,</span> <span class=err>R</span><span class=m>9</span><span class=err>D</span><span class=p>,</span> <span class=err>R</span><span class=m>10</span><span class=err>D</span><span class=p>,</span> <span class=err>R</span><span class=m>11</span><span class=err>D</span><span class=p>,</span> <span class=err>R</span><span class=m>14</span><span class=err>D</span><span class=p>,</span> <span class=err>R</span><span class=m>15</span><span class=err>D</span><span class=p>,</span> <span class=err>R</span><span class=m>12</span><span class=err>D</span><span class=p>,</span> <span class=err>R</span><span class=m>13</span><span class=err>D</span><span class=p>]&gt;</span> <span class=p>{</span> <span class=p>...</span> <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>The language used in the <code>.td</code> files are Target(Hardware) Description Language that let lvvm backend compiler engineers to define the transformations for llvm IR and the machine instructions of their CPUs.</p><p>In frontend, compiler development tools provide the &ldquo;ParseGenerator&rdquo; for compiler development; in backend they provide the &ldquo;Machine Code Generator&rdquo; for development, as you can see below:</p><p><img src=https://pietraferreira.github.io/quartz//notes/images/front-tablegen-flow.png width=auto alt></p><p><img src=https://pietraferreira.github.io/quartz//notes/imagesllvm-tablegen-flow.png width=auto alt></p><a href=#code-generation-sequence><h2 id=code-generation-sequence><span class=hanchor arialabel=Anchor># </span>Code Generation Sequence</h2></a><p>From tricore_llvm.pdf:</p><p><img src=https://pietraferreira.github.io/quartz//notes/images/llvm-code-generation-sequence.png width=auto alt></p><p>LLVM is a Static Single Assignment (SSA) based representation. LLVM provides an infinite virtual registers which can hold values of primitive type (integral, floating point, or pointer values). So, every operand can be saved in different virtual register in llvm SSA representation. Comment is ‚Äú;‚Äù in llvm representation. Following is the llvm SSA instructions:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-LLVM data-lang=LLVM><span class=line><span class=cl><span class=k>store</span> <span class=k>i32</span> <span class=m>0</span><span class=p>,</span> <span class=k>i32</span><span class=p>*</span> <span class=nv>%a</span>  <span class=c>; store i32 type of 0 to virtual register %a, %a is  
</span></span></span><span class=line><span class=cl><span class=c></span>                      <span class=c>; pointer type which point to i32 value  
</span></span></span><span class=line><span class=cl><span class=c></span><span class=k>store</span> <span class=k>i32</span> <span class=nv>%b</span><span class=p>,</span> <span class=k>i32</span><span class=p>*</span> <span class=nv>%c</span> <span class=c>; store %b contents to %c point to, %b isi32 type virtual  
</span></span></span><span class=line><span class=cl><span class=c></span>                      <span class=c>; register, %c is pointer type which point to i32 value.  
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>%a1</span> <span class=p>=</span> <span class=k>load</span> <span class=k>i32</span><span class=p>*</span> <span class=nv>%a</span>    <span class=c>; load the memory value where %a point to and assign the  
</span></span></span><span class=line><span class=cl><span class=c></span>                      <span class=c>; memory value to %a1  
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>%a3</span> <span class=p>=</span> <span class=k>add</span> <span class=k>i32</span> <span class=nv>%a2</span><span class=p>,</span> <span class=m>1</span>  <span class=c>; add %a2 and 1 and save to %a3
</span></span></span></code></pre></td></tr></table></div></div><p>Here you can see the code generation process:</p><ol><li>Instruction Selection</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-LLVM data-lang=LLVM><span class=line><span class=cl><span class=c>; In this stage, transfer the llvm opcode into machine opcode, but the operand  
</span></span></span><span class=line><span class=cl><span class=c>; still is llvm virtual operand.  
</span></span></span><span class=line><span class=cl><span class=c></span>   <span class=k>store</span> <span class=k>i16</span> <span class=m>0</span><span class=p>,</span> <span class=k>i16</span><span class=p>*</span> <span class=nv>%a</span> <span class=c>; store 0 of i16 type to where virtual register %a  
</span></span></span><span class=line><span class=cl><span class=c></span>                        <span class=c>; point to.  
</span></span></span><span class=line><span class=cl><span class=c></span><span class=p>=&gt;</span> <span class=err>st</span> <span class=k>i16</span> <span class=m>0</span><span class=p>,</span> <span class=k>i32</span><span class=p>*</span> <span class=nv>%a</span>    <span class=c>; Use Cpu0 backend instruction st instead of IR store.
</span></span></span></code></pre></td></tr></table></div></div><ol start=2><li>Scheduling and Formation</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-LLVM data-lang=LLVM><span class=line><span class=cl><span class=c>; In this stage, reorder the instructions sequence for optimization in  
</span></span></span><span class=line><span class=cl><span class=c>; instructions cycle or in register pressure.  
</span></span></span><span class=line><span class=cl><span class=c></span>   <span class=err>st</span> <span class=k>i32</span> <span class=nv>%a</span><span class=p>,</span> <span class=k>i16</span><span class=p>*</span> <span class=nv>%b</span><span class=p>,</span> <span class=k>i16</span> <span class=m>5</span> <span class=err>//</span> <span class=err>st</span> <span class=nv>%a</span> <span class=k>to</span> <span class=p>*(</span><span class=nv>%b</span><span class=err>+</span><span class=m>5</span><span class=p>)</span>  
</span></span><span class=line><span class=cl>   <span class=err>st</span> <span class=nv>%b</span><span class=p>,</span> <span class=k>i32</span><span class=p>*</span> <span class=nv>%c</span><span class=p>,</span> <span class=k>i16</span> <span class=m>0</span>  
</span></span><span class=line><span class=cl>   <span class=nv>%d</span> <span class=p>=</span> <span class=err>ld</span> <span class=k>i32</span><span class=p>*</span> <span class=nv>%c</span>  
</span></span><span class=line><span class=cl><span class=c>; Transfer above instructions order as follows. In RISC CPU of Mips, the ld  
</span></span></span><span class=line><span class=cl><span class=c>; %c uses the result of the previous instruction st %c. So it must waits 1  
</span></span></span><span class=line><span class=cl><span class=c>; cycle. Meaning the ld cannot follow st immediately.  
</span></span></span><span class=line><span class=cl><span class=c></span><span class=p>=&gt;</span> <span class=err>st</span> <span class=nv>%b</span><span class=p>,</span> <span class=k>i32</span><span class=p>*</span> <span class=nv>%c</span><span class=p>,</span> <span class=k>i16</span> <span class=m>0</span>  
</span></span><span class=line><span class=cl>   <span class=err>st</span> <span class=k>i32</span> <span class=nv>%a</span><span class=p>,</span> <span class=k>i16</span><span class=p>*</span> <span class=nv>%b</span><span class=p>,</span> <span class=k>i16</span> <span class=m>5</span>  
</span></span><span class=line><span class=cl>   <span class=nv>%d</span> <span class=p>=</span> <span class=err>ld</span> <span class=k>i32</span><span class=p>*</span> <span class=nv>%c</span><span class=p>,</span> <span class=k>i16</span> <span class=m>0</span>  
</span></span><span class=line><span class=cl><span class=c>; If without reorder instructions, a instruction nop which do nothing must be  
</span></span></span><span class=line><span class=cl><span class=c>; filled, contribute one instruction cycle more than optimization. (Actually,  
</span></span></span><span class=line><span class=cl><span class=c>; Mips is scheduled with hardware dynamically and will insert nop between st  
</span></span></span><span class=line><span class=cl><span class=c>; and ld instructions if compiler didn&#39;t insert nop.)  
</span></span></span><span class=line><span class=cl><span class=c></span>   <span class=err>st</span> <span class=k>i32</span> <span class=nv>%a</span><span class=p>,</span> <span class=k>i16</span><span class=p>*</span> <span class=nv>%b</span><span class=p>,</span> <span class=k>i16</span> <span class=m>5</span>  
</span></span><span class=line><span class=cl>   <span class=err>st</span> <span class=nv>%b</span><span class=p>,</span> <span class=k>i32</span><span class=p>*</span> <span class=nv>%c</span><span class=p>,</span> <span class=k>i16</span> <span class=m>0</span>  
</span></span><span class=line><span class=cl>   <span class=err>nop</span>  
</span></span><span class=line><span class=cl>   <span class=nv>%d</span> <span class=p>=</span> <span class=err>ld</span> <span class=k>i32</span><span class=p>*</span> <span class=nv>%c</span><span class=p>,</span> <span class=k>i16</span> <span class=m>0</span>  
</span></span><span class=line><span class=cl><span class=c>; Minimum register pressure  
</span></span></span><span class=line><span class=cl><span class=c>; Suppose %c is alive after the instructions basic block (meaning %c will be  
</span></span></span><span class=line><span class=cl><span class=c>; used after the basic block), %a and %b are not alive after that.  
</span></span></span><span class=line><span class=cl><span class=c>; The following no-reorder-version need 3 registers at least  
</span></span></span><span class=line><span class=cl><span class=c></span>   <span class=nv>%a</span> <span class=p>=</span> <span class=k>add</span> <span class=k>i32</span> <span class=m>1</span><span class=p>,</span> <span class=k>i32</span> <span class=m>0</span>  
</span></span><span class=line><span class=cl>   <span class=nv>%b</span> <span class=p>=</span> <span class=k>add</span> <span class=k>i32</span> <span class=m>2</span><span class=p>,</span> <span class=k>i32</span> <span class=m>0</span>  
</span></span><span class=line><span class=cl>   <span class=err>st</span> <span class=nv>%a</span><span class=p>,</span> <span class=k>i32</span><span class=p>*</span> <span class=nv>%c</span><span class=p>,</span> <span class=m>1</span>  
</span></span><span class=line><span class=cl>   <span class=err>st</span> <span class=nv>%b</span><span class=p>,</span> <span class=k>i32</span><span class=p>*</span> <span class=nv>%c</span><span class=p>,</span> <span class=m>2</span>  
</span></span><span class=line><span class=cl><span class=c>; The reorder version needs 2 registers only (by allocate %a and %b in the same  
</span></span></span><span class=line><span class=cl><span class=c>; register)  
</span></span></span><span class=line><span class=cl><span class=c></span><span class=p>=&gt;</span> <span class=nv>%a</span> <span class=p>=</span> <span class=k>add</span> <span class=k>i32</span> <span class=m>1</span><span class=p>,</span> <span class=k>i32</span> <span class=m>0</span>  
</span></span><span class=line><span class=cl>   <span class=err>st</span> <span class=nv>%a</span><span class=p>,</span> <span class=k>i32</span><span class=p>*</span> <span class=nv>%c</span><span class=p>,</span> <span class=m>1</span>  
</span></span><span class=line><span class=cl>   <span class=nv>%b</span> <span class=p>=</span> <span class=k>add</span> <span class=k>i32</span> <span class=m>2</span><span class=p>,</span> <span class=k>i32</span> <span class=m>0</span>  
</span></span><span class=line><span class=cl>   <span class=err>st</span> <span class=nv>%b</span><span class=p>,</span> <span class=k>i32</span><span class=p>*</span> <span class=nv>%c</span><span class=p>,</span> <span class=m>2</span>
</span></span></code></pre></td></tr></table></div></div><ol start=3><li><p>SSA-based Machine Code Optimisation</p></li><li><p>Register Allocation
Allocate real register for virtual register.</p></li><li><p>Prologue/Epilogue Code Insertion</p></li><li><p>Late Machine Code Optimisations
Any &rsquo;last-minute&rsquo; peephole optimisations for the final machine code can be applied during this phase.</p></li><li><p>Code Emission
For static compilation, the end result is an assembly code file. For JIT compilation, the opcodes of the machine instructions are written into memory.</p></li></ol><a href=#llvm-vs-gcc-in-structure><h2 id=llvm-vs-gcc-in-structure><span class=hanchor arialabel=Anchor># </span>LLVM vs GCC in structure</h2></a><p>Related to
<a href=/quartz/notes/gcc/ rel=noopener class=internal-link data-src=/quartz/notes/gcc/>gcc</a>.</p><p><img src=https://pietraferreira.github.io/quartz//notes/images/gcc-vs-llvm-structure.png width=auto alt></p><a href=#online-resources><h2 id=online-resources><span class=hanchor arialabel=Anchor># </span>Online resources</h2></a><ul><li><a href=https://llvm.org/docs/ rel=noopener>LLVM Compiler Infrastructure documentation</a></li><li><a href=https://www.youtube.com/channel/UCv2_41bSAa5Y_8BacJUZfjQ rel=noopener>LLVM YouTube channel</a></li><li><a href=https://jonathan2251.github.io/lbd/TutorialLLVMBackendCpu0.pdf rel=noopener>Tutorial LLVM backend</a></li><li><a href=https://llvm.org/docs/CodeGenerator.html rel=noopener>LLVM Backend - Code Generator</a></li><li><a href=https://llvm.org/docs/tutorial/ rel=noopener>LLVM Official Tutorials</a></li><li><a href=https://gnuu.org/2009/09/18/writing-your-own-toy-compiler/ rel=noopener>Writing Your Own Toy Compiler Using Flex, Bison and LLVM</a></li></ul><a href=#mailing-lists><h3 id=mailing-lists><span class=hanchor arialabel=Anchor># </span>Mailing lists</h3></a><ul><li><a href=https://lists.llvm.org/pipermail/llvm-dev/ rel=noopener>The llvm-dev Archives</a></li></ul><a href=#resources><h2 id=resources><span class=hanchor arialabel=Anchor># </span>Resources</h2></a><ul><li><a href=/quartz/notes/how-to-write-a-llvm-backend/ rel=noopener class=internal-link data-src=/quartz/notes/how-to-write-a-llvm-backend/>How to Write a LLVM Backend</a></li></ul></article><hr><div class=page-end><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li><a href=/quartz/notes/compiler-toolchains/ data-ctx=LLVM data-src=/notes/compiler-toolchains class=internal-link>Compiler Toolchains</a></li><li><a href=/quartz/notes/compilers/ data-ctx=LLVM data-src=/notes/compilers class=internal-link>Compilers</a></li><li><a href=/quartz/notes/riscv-toolchain/ data-ctx="llvm toolchain" data-src=/notes/riscv-toolchain class=internal-link>RISC-V Toolchain</a></li><li><a href=/quartz/notes/work-hub/ data-ctx=LLVM data-src=/notes/work-hub class=internal-link>Work Hub</a></li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://pietraferreira.github.io/quartz/js/graph.afdb02e537635f9a611b53a988e5645b.js></script></div></div><div id=contact_buttons><footer><p>Made by Morioh using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, ¬© 2022</p><ul><li><a href=https://pietraferreira.github.io/quartz/>Home</a></li><li><a href=https://github.com/pietraferreira>Github</a></li></ul></footer></div></div></body></html>